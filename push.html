<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>üìû Diamond Phone</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.19.2.js"></script>

    <style>
        :root{--primary:#3b82f6;--danger:#ef4444;--bg:#0f172a;--card:#1e293b;--text:#f8fafc;--text2:#94a3b8;--border:#334155}
        *{margin:0;padding:0;box-sizing:border-box;font-family:Inter,system-ui,sans-serif}
        body{background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column}
        /* ---------- –≤—Ö–æ–¥ ---------- */
        .login{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:20px;text-align:center}
        .login h1{margin-bottom:12px}
        .login input{width:100%;max-width:300px;padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:#0f172a;color:var(--text);margin-top:8px}
        .login button{margin-top:16px;width:100%;max-width:300px;padding:12px;border:none;border-radius:10px;background:var(--primary);color:#fff;font-weight:600;cursor:pointer}
        /* ---------- –∫–Ω–∏–∂–∫–∞ ---------- */
        .book{display:none;flex-direction:column;height:100%}
        header{padding:14px 20px;background:var(--card);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
        .myAvatar{width:36px;height:36px;border-radius:50%}
        .search{padding:10px 20px}
        .search input{width:100%;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#0f172a;color:var(--text)}
        .list{flex:1;overflow-y:auto;padding:0 20px 20px}
        .contact{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;margin-bottom:10px;background:var(--card);position:relative}
        .contact img{width:48px;height:48px;border-radius:50%;object-fit:cover;background:var(--border)}
        .contact .info{flex:1}
        .contact .name{font-weight:600}
        .contact .nick{font-size:.75rem;color:var(--text2)}
        .contact .status{font-size:.65rem;position:absolute;top:12px;right:12px;display:flex;align-items:center;gap:4px}
        .online-dot{width:8px;height:8px;border-radius:50%;background:#22c55e}
        .callBtn{background:var(--primary);border:none;color:#fff;width:36px;height:36px;border-radius:50%;display:grid;place-items:center;font-size:1rem;cursor:pointer}
        /* ---------- –∑–≤–æ–Ω–æ–∫ ---------- */
        .call{display:none;position:fixed;inset:0;background:#000;flex-direction:column}
        .call.active{display:flex}
        .callHead{background:rgba(0,0,0,.6);padding:12px 16px;display:flex;align-items:center;gap:12px}
        .callHead button{background:rgba(255,255,255,.15);border:none;color:#fff;width:36px;height:36px;border-radius:50%;display:grid;place-items:center;font-size:1rem;cursor:pointer}
        .callTitle{flex:1;font-weight:600}
        .videoBox{flex:1;position:relative;display:flex;align-items:center;justify-content:center}
        .remoteVideo{width:100%;height:100%;object-fit:cover}
        .localVideo{position:absolute;bottom:100px;right:20px;width:100px;height:150px;border-radius:12px;object-fit:cover;border:2px solid rgba(255,255,255,.3)}
        .controls{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.7));padding:25px 20px;display:flex;justify-content:center;gap:40px}
        .ctrl{width:60px;height:60px;border-radius:50%;border:none;color:#fff;font-size:1.3rem;cursor:pointer}
        .ctrl.mic,.ctrl.cam{background:var(--primary)}
        .ctrl.end{background:var(--danger)}
    </style>
</head>
<body>

<!--------------------------------------------------
      1.  –≠–ö–†–ê–ù –í–•–û–î–ê
--------------------------------------------------->
<div class="login" id="loginScreen">
    <h1>üìû Diamond Phone</h1>
    <p>–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π @–Ω–∏–∫</p>
    <input id="nickInput" placeholder="@ivanov" maxlength="20">
    <button id="enterBtn">–í–æ–π—Ç–∏</button>
</div>

<!--------------------------------------------------
      2.  –¢–ï–õ–ï–§–û–ù–ù–ê–Ø –ö–ù–ò–ñ–ö–ê
--------------------------------------------------->
<div class="book" id="bookScreen">
    <header>
        <img id="myAva" src="avatar/1.png"><span id="myNick"></span>
    </header>
    <div class="search"><input id="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ @–Ω–∏–∫—É‚Ä¶"></div>
    <div class="list" id="list"></div>
</div>

<!--------------------------------------------------
      3.  –≠–ö–†–ê–ù –ó–í–û–ù–ö–ê
--------------------------------------------------->
<div class="call" id="callScreen">
    <div class="callHead">
        <button id="hangUp"><i class="fa-solid fa-arrow-left"></i></button>
        <div class="callTitle" id="callTitle">–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</div>
    </div>
    <div class="videoBox">
        <video class="remoteVideo" id="remoteVideo" autoplay playsinline></video>
        <video class="localVideo" id="localVideo" autoplay playsinline muted></video>
    </div>
    <div class="controls">
        <button class="ctrl mic"  id="micBtn"><i class="fa-solid fa-microphone"></i></button>
        <button class="ctrl end"  id="endBtn"><i class="fa-solid fa-phone-slash"></i></button>
        <button class="ctrl cam"  id="camBtn"><i class="fa-solid fa-video"></i></button>
    </div>
</div>

<script>
/* =================================================
      0.  –ö–û–ù–§–ò–ì–ò  (–≤–∞—à–∏ –∏–∑ app.js)
================================================= */
const firebaseCfg = {
    apiKey: "AIzaSyB0ca3id5sWRk4a49s6OnYhpGQEtpi_h9Q",
    authDomain: "diamond-russia-8e454.firebaseapp.com",
    databaseURL: "https://diamond-russia-8e454-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "diamond-russia-8e454",
    storageBucket: "diamond-russia-8e454.appspot.com",
    messagingSenderId: "735387033487",
    appId: "1:735387033487:web:7ec3ff71a2aaed612775fa"
};
const agoraAppId = "fc97c0f924ce4bec9389fa2cf4899e48";

firebase.initializeApp(firebaseCfg);
const db = firebase.database();
let client, localTracks={audio:null,video:null};
let myNick='', micOn=true, camOn=true;

/* =================================================
      1.  –í–•–û–î  (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–æ–∫)
================================================= */
document.getElementById('enterBtn').onclick = ()=>{
    const n = document.getElementById('nickInput').value.trim();
    if(!n) return;
    myNick = n.startsWith('@') ? n : '@'+n;
    document.getElementById('myNick').textContent = myNick;
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('bookScreen').style.display='flex';
    loadAllUsers();
    watchForCalls();          // —Å–ª—É—à–∞–µ–º –≤—Ö–æ–¥—è—â–∏–µ
};

/* =================================================
      2.  –ó–ê–ì–†–£–ñ–ê–ï–ú  –í–°–ï–•  –ò–ó  /users
================================================= */
let allUsers=[];
function loadAllUsers(){
    db.ref('users').on('value',snap=>{
        allUsers=[];
        snap.forEach(ch=>{
            const d=ch.val();
            allUsers.push({
                nick : ch.key,
                name : d.username||ch.key,
                avatar: d.avatarUrl||`avatar/1.png`,
                online: d.isOnline||false,
                lastSeen: d.lastSeen||0
            });
        });
        renderList();
    });
}

/* =================================================
      3.  –†–ï–ù–î–ï–†  (—Å–µ–±—è –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º)
================================================= */
function renderList(filter=''){
    const html = allUsers
        .filter(u=> u.nick!==myNick && (u.name.toLowerCase().includes(filter)||u.nick.includes(filter)) )
        .map(u=>{
            const st = u.online ? '<span class="online-dot"></span> –æ–Ω–ª–∞–π–Ω' : `–±—ã–ª(–∞) ${timeAgo(u.lastSeen)}`;
            return `
            <div class="contact">
                <img src="${u.avatar}" alt="">
                <div class="info">
                    <div class="name">${u.name}</div>
                    <div class="nick">${u.nick}</div>
                </div>
                <div class="status">${st}</div>
                <button class="callBtn" onclick="callUser('${u.nick}')" title="–ü–æ–∑–≤–æ–Ω–∏—Ç—å"><i class="fa-solid fa-phone"></i></button>
            </div>`;
        }).join('');
    document.getElementById('list').innerHTML = html || '<div style="text-align:center;margin-top:40px;color:var(--text2)">–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
}
document.getElementById('search').oninput = e=> renderList(e.target.value.toLowerCase());

/* =================================================
      4.  –ò–°–•–û–î–Ø–©–ò–ô  –ó–í–û–ù–û–ö
================================================= */
async function callUser(peerNick){
    const room = [myNick, peerNick].sort().join('_');
    document.getElementById('callTitle').textContent = `–ó–≤–æ–Ω–æ–∫ ${peerNick}`;
    openCallScreen();
    await joinAgora(room);
}

/* =================================================
      5.  –í–•–û–î–Ø–©–ò–ô  –ó–í–û–ù–û–ö  (—Å–ª–µ–¥–∏–º –∑–∞ –∫–æ–º–Ω–∞—Ç–æ–π)
================================================= */
function watchForCalls(){
    // –∫–æ–º–Ω–∞—Ç—ã, –≥–¥–µ —è —É—á–∞—Å—Ç–Ω–∏–∫:  room=[xxx, myNick].sort().join('_')
    db.ref('calls').on('child_added', snap=>{
        const room = snap.key;
        const from = snap.val().from;
        if(!room.includes(myNick) || from===myNick) return;   // —ç—Ç–æ –Ω–µ –º–æ–π –∑–≤–æ–Ω–æ–∫
        document.getElementById('callTitle').textContent = `–í—Ö–æ–¥—è—â–∏–π –æ—Ç ${from}`;
        openCallScreen();
        joinAgora(room);
    });
}

/* =================================================
      6.  Agora  (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
================================================= */
async function joinAgora(room){
    client = AgoraRTC.createClient({mode:"rtc",codec:"vp8"});
    await client.join(agoraAppId, room, null, null);

    localTracks.audio = await AgoraRTC.createMicrophoneAudioTrack();
    localTracks.video = await AgoraRTC.createCameraVideoTrack();
    await client.publish([localTracks.audio, localTracks.video]);
    localTracks.video.play(document.getElementById('localVideo'));

    client.on("user-published", async (user,mediaType)=>{
        await client.subscribe(user,mediaType);
        if(mediaType==="video") user.videoTrack.play(document.getElementById('remoteVideo'));
        if(mediaType==="audio") user.audioTrack.play();
    });
    // –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º ‚Äì —É–±–∏—Ä–∞–µ–º —ç–∫—Ä–∞–Ω
    client.on("user-left", ()=> closeCallScreen() );
}

/* =================================================
      7.  UI  –∑–≤–æ–Ω–∫–∞
================================================= */
function openCallScreen(){
    document.getElementById('callScreen').classList.add('active');
}
function closeCallScreen(){
    document.getElementById('callScreen').classList.remove('active');
    if(client) client.leave();
    if(localTracks.audio){ localTracks.audio.close(); localTracks.audio=null; }
    if(localTracks.video){ localTracks.video.close(); localTracks.video=null; }
}
document.getElementById('hangUp').onclick = document.getElementById('endBtn').onclick = closeCallScreen;
document.getElementById('micBtn').onclick  = ()=>{ micOn=!micOn; localTracks.audio.setEnabled(micOn); document.getElementById('micBtn').style.background = micOn?'var(--primary)':'#555'; };
document.getElementById('camBtn').onclick  = ()=>{ camOn=!camOn; localTracks.video.setEnabled(camOn); document.getElementById('camBtn').style.background = camOn?'var(--primary)':'#555'; };

/* =================================================
      8.  –ú–µ–ª–æ—á—å
================================================= */
function timeAgo(ts){
    const min = Math.floor((Date.now()-ts)/60000);
    if(min<1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if(min<60) return `${min} –º–∏–Ω –Ω–∞–∑–∞–¥`;
    return `${Math.floor(min/60)} —á –Ω–∞–∑–∞–¥`;
}
</script>
</body>
</html>
