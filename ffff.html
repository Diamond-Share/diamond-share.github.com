<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoPhone</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        :root {
            --primary: #007AFF;
            --primary-dark: #0056CC;
            --background: #000000;
            --surface: #1C1C1E;
            --card: #2C2C2E;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --accent: #FF2D55;
            --success: #32D74B;
            --gradient: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            --glass: rgba(255, 255, 255, 0.1);
        }

        body {
            background: var(--background);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Анимированный фон */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 45, 85, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 122, 255, 0.15) 0%, transparent 50%);
            animation: bgMove 20s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes bgMove {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(180deg); }
        }

        .screen { 
            display: none; 
            padding: 20px; 
            height: 100vh; 
            overflow-y: auto;
        }
        
        .screen.active { 
            display: block; 
        }

        .header {
            padding: 50px 30px 25px;
            text-align: center;
            position: relative;
            flex-shrink: 0;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: var(--gradient);
            border-radius: 16px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 8px 32px rgba(0, 122, 255, 0.3);
            animation: logoFloat 3s ease-in-out infinite;
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .header h1 {
            font-size: 36px;
            font-weight: 800;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 6px;
            letter-spacing: -0.5px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 500;
        }

        .tab-bar {
            display: flex;
            background: var(--surface);
            margin: 0 20px 20px;
            border-radius: 20px;
            padding: 6px;
            position: relative;
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass);
            flex-shrink: 0;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
            border-radius: 14px;
        }

        .tab.active {
            color: var(--text-primary);
        }

        .tab-indicator {
            position: absolute;
            top: 6px;
            left: 6px;
            width: calc(25% - 12px);
            height: calc(100% - 12px);
            background: var(--gradient);
            border-radius: 14px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.3);
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px 20px;
            display: flex;
            flex-direction: column;
        }

        .tab-content {
            display: none;
            flex: 1;
            animation: fadeIn 0.5s ease;
            overflow-y: auto;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Избранное */
        .favorites-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 10px 0;
            flex: 1;
        }

        .favorite-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            padding: 10px;
        }

        .favorite-avatar {
            width: 70px;
            height: 70px;
            border-radius: 20px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 24px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .favorite-avatar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .favorite-avatar:active::before {
            left: 100%;
        }

        .favorite-avatar:active {
            transform: scale(0.95);
        }

        .favorite-name {
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            color: var(--text-primary);
        }

        .favorite-add {
            background: var(--card);
            border: 2px dashed var(--text-secondary);
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: 300;
        }

        /* Недавние */
        .recent-calls {
            background: var(--surface);
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid var(--glass);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .call-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: background 0.3s ease;
            flex-shrink: 0;
        }

        .call-item:last-child {
            border-bottom: none;
        }

        .call-item:active {
            background: var(--card);
        }

        .call-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
            font-size: 16px;
        }

        .call-incoming {
            background: var(--success);
        }

        .call-outgoing {
            background: var(--primary);
        }

        .call-missed {
            background: var(--accent);
        }

        .call-info {
            flex-grow: 1;
        }

        .call-name {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .call-details {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }

        .call-time {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Контакты */
        .search-container {
            padding: 16px 20px;
            position: relative;
            background: var(--surface);
            border-radius: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--glass);
            flex-shrink: 0;
        }

        .search-box {
            width: 100%;
            padding: 14px 20px 14px 45px;
            background: var(--card);
            border: none;
            border-radius: 14px;
            font-size: 16px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--primary);
        }

        .search-icon {
            position: absolute;
            left: 32px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 16px;
        }

        .contact-list {
            background: var(--surface);
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid var(--glass);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: background 0.3s ease;
            flex-shrink: 0;
        }

        .contact-item:last-child {
            border-bottom: none;
        }

        .contact-item:active {
            background: var(--card);
        }

        .contact-avatar {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
            margin-right: 15px;
        }

        .contact-info {
            flex-grow: 1;
        }

        .contact-name {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .contact-phone {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Клавиатура */
        .keypad-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .phone-number {
            font-size: 36px;
            font-weight: 300;
            letter-spacing: 1px;
            margin-bottom: 30px;
            padding: 20px;
            text-align: center;
            background: var(--surface);
            border-radius: 20px;
            border: 1px solid var(--glass);
            font-feature-settings: "tnum";
            flex-shrink: 0;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            flex: 1;
            min-height: 0;
            margin-bottom: 20px;
        }

        .key {
            width: 70px;
            height: 70px;
            border-radius: 35px;
            background: var(--card);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--glass);
            user-select: none;
            -webkit-user-select: none;
        }

        .key::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .key:active::before {
            opacity: 0.1;
        }

        .key:active {
            transform: scale(0.95);
        }

        .key .letters {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .key .number {
            position: relative;
            z-index: 1;
        }

        .key-call {
            background: var(--success);
            grid-column: 2;
        }

        .key-call:active {
            background: #28a745;
        }

        .key-delete {
            background: transparent;
            color: var(--accent);
            font-size: 22px;
        }

        .call-controls {
            display: flex;
            justify-content: space-between;
            padding: 0 30px;
            flex-shrink: 0;
        }

        .control {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .control-button {
            width: 55px;
            height: 55px;
            border-radius: 28px;
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 6px;
            color: var(--primary);
            font-size: 22px;
            transition: all 0.3s ease;
            border: 1px solid var(--glass);
        }

        .control-button:active {
            transform: scale(0.95);
            background: var(--primary);
            color: white;
        }

        .control-label {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Регистрация */
        .register-card {
            background: var(--surface);
            border-radius: 20px;
            padding: 25px;
            margin: 0 20px;
            border: 1px solid var(--glass);
        }

        .register-input {
            width: 100%;
            padding: 15px;
            background: var(--card);
            border: 1px solid var(--glass);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            margin-bottom: 15px;
        }

        .register-btn {
            width: 100%;
            padding: 15px;
            background: var(--gradient);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Входящий звонок */
        .incoming-call {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .incoming-call.active {
            display: flex;
        }
        
        .caller-info {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .caller-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: bold;
            margin: 0 auto 20px;
        }
        
        .caller-name {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .caller-phone {
            font-size: 18px;
            color: var(--text-secondary);
        }
        
        .call-actions {
            display: flex;
            gap: 30px;
        }
        
        .accept-call {
            width: 80px;
            height: 80px;
            border-radius: 40px;
            background: var(--success);
            border: none;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }
        
        .reject-call {
            width: 80px;
            height: 80px;
            border-radius: 40px;
            background: var(--accent);
            border: none;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }

        /* Звонок */
        .video-container { 
            position: relative; 
            width: 100%; 
            height: 70vh; 
            background: var(--surface); 
            border-radius: 15px; 
            overflow: hidden; 
            border: 1px solid var(--glass);
        }
        
        .local-video { 
            position: absolute; 
            bottom: 20px; 
            right: 20px; 
            width: 120px; 
            height: 160px; 
            border-radius: 10px; 
            border: 2px solid var(--text-primary); 
            object-fit: cover; 
            z-index: 10;
        }
        
        .remote-video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        
        .call-controls { 
            position: fixed; 
            bottom: 30px; 
            left: 0; 
            right: 0; 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
        }
        
        .call-control-btn { 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            border: none; 
            background: var(--gradient); 
            color: white; 
            font-size: 20px; 
            cursor: pointer; 
        }
        
        .end-call { 
            background: var(--accent); 
            width: 70px; 
            height: 70px; 
        }

        .loader { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.8); 
            z-index: 9999; 
            justify-content: center; 
            align-items: center; 
            flex-direction: column; 
        }
        
        .loader.active { 
            display: flex; 
        }
        
        .spinner { 
            width: 40px; 
            height: 40px; 
            border: 4px solid rgba(255,255,255,0.3); 
            border-radius: 50%; 
            border-top-color: var(--primary); 
            animation: spin 1s linear infinite; 
        }

        .notification { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--surface); 
            border-left: 4px solid var(--primary); 
            padding: 15px; 
            border-radius: 10px; 
            display: none; 
            z-index: 1000;
        }
        
        .notification.show { 
            display: block; 
        }

        .pulse {
            animation: pulse 1s infinite;
        }
        
        @keyframes spin { 
            to { 
                transform: rotate(360deg); 
            } 
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-up {
            animation: slideUp 0.6s ease;
        }

        .fade-in {
            animation: fadeIn 0.6s ease;
        }

        /* Прокрутка */
        ::-webkit-scrollbar {
            width: 0px;
        }

        /* Исправления для мобильных устройств */
        @media (max-height: 700px) {
            .header {
                padding: 30px 20px 15px;
            }
            
            .favorite-avatar {
                width: 60px;
                height: 60px;
                font-size: 20px;
            }
            
            .key {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
            
            .phone-number {
                font-size: 30px;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Анимированный фон -->
    <div class="bg-animation"></div>

    <!-- Загрузчик -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <div id="loaderText">Загрузка...</div>
    </div>

    <!-- Экран регистрации -->
    <div id="registerScreen" class="screen active">
        <div class="header slide-up">
            <div class="logo">
                <i class="fas fa-phone-alt"></i>
            </div>
            <h1>NeoPhone</h1>
            <p>Премиум видеозвонки</p>
        </div>

        <div class="register-card">
            <h3 style="text-align: center; margin-bottom: 20px;">Регистрация</h3>
            <input type="text" id="usernameInput" class="register-input" placeholder="Ваше имя" maxlength="20">
            <input type="tel" id="phoneInput" class="register-input" placeholder="Ваш номер телефона" maxlength="15">
            <button id="registerBtn" class="register-btn">Продолжить</button>
        </div>
    </div>

    <!-- Главный экран -->
    <div id="mainScreen" class="screen">
        <div class="header">
            <div class="logo">
                <i class="fas fa-phone-alt"></i>
            </div>
            <h1>NeoPhone</h1>
            <p>Добро пожаловать, <span id="userName"></span></p>
        </div>

        <!-- Панель вкладок -->
        <div class="tab-bar fade-in">
            <div class="tab-indicator"></div>
            <div class="tab active" data-tab="favorites">
                <i class="fas fa-star"></i>
            </div>
            <div class="tab" data-tab="recent">
                <i class="fas fa-clock"></i>
            </div>
            <div class="tab" data-tab="contacts">
                <i class="fas fa-user"></i>
            </div>
            <div class="tab" data-tab="keypad">
                <i class="fas fa-square"></i>
            </div>
        </div>

        <!-- Контейнер содержимого -->
        <div class="content">
            <!-- Вкладка Избранное -->
            <div class="tab-content active" id="favorites">
                <div class="favorites-grid">
                    <a href="#" class="favorite-item">
                        <div class="favorite-avatar">М</div>
                        <div class="favorite-name">Мама</div>
                    </a>
                    <a href="#" class="favorite-item">
                        <div class="favorite-avatar">П</div>
                        <div class="favorite-name">Папа</div>
                    </a>
                    <a href="#" class="favorite-item">
                        <div class="favorite-avatar">А</div>
                        <div class="favorite-name">Анна</div>
                    </a>
                    <a href="#" class="favorite-item">
                        <div class="favorite-avatar">И</div>
                        <div class="favorite-name">Иван</div>
                    </a>
                    <a href="#" class="favorite-item">
                        <div class="favorite-avatar">Д</div>
                        <div class="favorite-name">Друг</div>
                    </a>
                    <a href="#" class="favorite-item">
                        <div class="favorite-avatar favorite-add">+</div>
                        <div class="favorite-name">Добавить</div>
                    </a>
                </div>
            </div>

            <!-- Вкладка Недавние -->
            <div class="tab-content" id="recent">
                <div class="recent-calls">
                    <div class="call-item">
                        <div class="call-icon call-incoming">
                            <i class="fas fa-phone-alt"></i>
                        </div>
                        <div class="call-info">
                            <div class="call-name">Мама</div>
                            <div class="call-details">
                                <span>Входящий</span> • <span>5 мин назад</span>
                            </div>
                        </div>
                        <div class="call-time">14:25</div>
                    </div>
                    <div class="call-item">
                        <div class="call-icon call-outgoing">
                            <i class="fas fa-phone-alt"></i>
                        </div>
                        <div class="call-info">
                            <div class="call-name">Анна</div>
                            <div class="call-details">
                                <span>Исходящий</span> • <span>1 час назад</span>
                            </div>
                        </div>
                        <div class="call-time">13:30</div>
                    </div>
                </div>
            </div>

            <!-- Вкладка Контакты -->
            <div class="tab-content" id="contacts">
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-box" placeholder="Поиск контактов...">
                </div>
                <div class="contact-list">
                    <div class="contact-item">
                        <div class="contact-avatar">А</div>
                        <div class="contact-info">
                            <div class="contact-name">Анна</div>
                            <div class="contact-phone">+7 (123) 456-78-90</div>
                        </div>
                    </div>
                    <div class="contact-item">
                        <div class="contact-avatar">И</div>
                        <div class="contact-info">
                            <div class="contact-name">Иван</div>
                            <div class="contact-phone">+7 (123) 456-78-91</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладка Клавиатура -->
            <div class="tab-content" id="keypad">
                <div class="keypad-container">
                    <div class="phone-number" id="phoneNumberDisplay">+7 (123) 456-78-94</div>
                    <div class="keypad">
                        <div class="key" data-number="1">
                            <div class="number">1</div>
                            <div class="letters"></div>
                        </div>
                        <div class="key" data-number="2">
                            <div class="number">2</div>
                            <div class="letters">ABC</div>
                        </div>
                        <div class="key" data-number="3">
                            <div class="number">3</div>
                            <div class="letters">DEF</div>
                        </div>
                        <div class="key" data-number="4">
                            <div class="number">4</div>
                            <div class="letters">GHI</div>
                        </div>
                        <div class="key" data-number="5">
                            <div class="number">5</div>
                            <div class="letters">JKL</div>
                        </div>
                        <div class="key" data-number="6">
                            <div class="number">6</div>
                            <div class="letters">MNO</div>
                        </div>
                        <div class="key" data-number="7">
                            <div class="number">7</div>
                            <div class="letters">PQRS</div>
                        </div>
                        <div class="key" data-number="8">
                            <div class="number">8</div>
                            <div class="letters">TUV</div>
                        </div>
                        <div class="key" data-number="9">
                            <div class="number">9</div>
                            <div class="letters">WXYZ</div>
                        </div>
                        <div class="key" data-number="*">
                            <div class="number">*</div>
                        </div>
                        <div class="key" data-number="0">
                            <div class="number">0</div>
                            <div class="letters">+</div>
                        </div>
                        <div class="key" data-number="#">
                            <div class="number">#</div>
                        </div>
                    </div>
                    <div class="call-controls">
                        <div class="control">
                            <div class="control-button">
                                <i class="fas fa-plus"></i>
                            </div>
                            <div class="control-label">Контакты</div>
                        </div>
                        <div class="control">
                            <div class="control-button key-call" id="makeCallBtn">
                                <i class="fas fa-phone-alt"></i>
                            </div>
                            <div class="control-label">Вызов</div>
                        </div>
                        <div class="control">
                            <div class="control-button key-delete" id="deleteBtn">
                                <i class="fas fa-delete-left"></i>
                            </div>
                            <div class="control-label">Удалить</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Экран звонка -->
    <div id="callScreen" class="screen">
        <div class="header">
            <div class="logo">NeoPhone</div>
            <p id="roomInfo">Звонок...</p>
        </div>

        <div class="video-container">
            <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
            <video id="localVideo" class="local-video" autoplay playsinline muted></video>
            <div id="waitingText" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--text-secondary); text-align: center;">
                Ожидание ответа...
            </div>
        </div>

        <div class="call-controls">
            <button id="micBtn" class="call-control-btn">🎤</button>
            <button id="cameraBtn" class="call-control-btn">📹</button>
            <button id="endCallBtn" class="call-control-btn end-call">📞</button>
        </div>
    </div>

    <!-- Входящий звонок -->
    <div id="incomingCall" class="incoming-call">
        <div class="caller-info">
            <div class="caller-avatar" id="callerAvatar">?</div>
            <div class="caller-name" id="callerName">Звонящий</div>
            <div class="caller-phone" id="callerPhone">+7 XXX XXX-XX-XX</div>
            <div style="margin-top: 10px; color: var(--text-secondary);">Вам звонят...</div>
        </div>
        <div class="call-actions">
            <button id="acceptCallBtn" class="accept-call pulse">📞</button>
            <button id="rejectCallBtn" class="reject-call">✖</button>
        </div>
    </div>

    <!-- Уведомление -->
    <div id="notification" class="notification">
        <div id="notificationText">Сообщение</div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <!-- Agora SDK -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.18.2.js"></script>
    
    <script>
        // Firebase конфигурация
        const firebaseConfig = {
            apiKey: "AIzaSyDvvp3qyBsQsZQfuwaImeZUZ4C0M9I912Q",
            authDomain: "skyberry-a31d8.firebaseapp.com",
            databaseURL: "https://skyberry-a31d8-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "skyberry-a31d8",
            storageBucket: "skyberry-a31d8.firebasestorage.app",
            messagingSenderId: "942887528624",
            appId: "1:942887528624:web:537f9f76d79d81be89b375",
            measurementId: "G-N2WKSHRB4L"
        };
        
        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Agora конфигурация
        const AGORA_APP_ID = "fc97c0f924ce4bec9389fa2cf4899e48";
        
        // Переменные
        let client;
        let localTracks = [];
        let remoteUsers = {};
        let currentUser = null;
        let currentPhone = null;
        let incomingCallListener = null;
        let currentCallListener = null;

        // Элементы
        const registerScreen = document.getElementById('registerScreen');
        const mainScreen = document.getElementById('mainScreen');
        const callScreen = document.getElementById('callScreen');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        const usernameInput = document.getElementById('usernameInput');
        const phoneInput = document.getElementById('phoneInput');
        const registerBtn = document.getElementById('registerBtn');
        const userName = document.getElementById('userName');
        const phoneNumberDisplay = document.getElementById('phoneNumberDisplay');
        const makeCallBtn = document.getElementById('makeCallBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const micBtn = document.getElementById('micBtn');
        const cameraBtn = document.getElementById('cameraBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const roomInfo = document.getElementById('roomInfo');
        const waitingText = document.getElementById('waitingText');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');
        const incomingCall = document.getElementById('incomingCall');
        const callerAvatar = document.getElementById('callerAvatar');
        const callerName = document.getElementById('callerName');
        const callerPhone = document.getElementById('callerPhone');
        const acceptCallBtn = document.getElementById('acceptCallBtn');
        const rejectCallBtn = document.getElementById('rejectCallBtn');

        // Показать уведомление
        function showNotification(message, duration = 3000) {
            notificationText.textContent = message;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), duration);
        }

        // Инициализация Agora
        function initAgora() {
            try {
                if (typeof AgoraRTC === 'undefined') {
                    throw new Error('Agora SDK не загружен');
                }

                // Создаем клиент
                client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
                
                // Настройка обработчиков событий
                client.on("user-published", async (user, mediaType) => {
                    await client.subscribe(user, mediaType);
                    showNotification('Участник присоединился!');

                    if (mediaType === "video") {
                        const remoteTrack = user.videoTrack;
                        remoteVideo.srcObject = new MediaStream([remoteTrack.getMediaStreamTrack()]);
                        remoteTrack.play(remoteVideo);
                        waitingText.style.display = 'none';
                    }
                    
                    if (mediaType === "audio") {
                        user.audioTrack.play();
                    }

                    remoteUsers[user.uid] = user;
                });

                client.on("user-unpublished", (user) => {
                    showNotification('Участник вышел');
                    if (remoteUsers[user.uid]) {
                        delete remoteUsers[user.uid];
                    }
                    if (Object.keys(remoteUsers).length === 0) {
                        waitingText.style.display = 'block';
                        remoteVideo.srcObject = null;
                    }
                });

                showNotification('Agora инициализирован!');
                
            } catch (error) {
                const errorMsg = `Ошибка инициализации Agora: ${error.message}`;
                showNotification(errorMsg);
                console.error('Agora error:', error);
            }
        }

        // Регистрация пользователя
        function registerUser() {
            const username = usernameInput.value.trim();
            const phone = phoneInput.value.trim();
            
            if (!username || !phone) {
                showNotification('Введите имя и номер телефона');
                return;
            }

            loader.classList.add('active');
            loaderText.textContent = 'Регистрация...';
            
            // Сохраняем пользователя в Firebase
            const userRef = database.ref('users/' + phone);
            
            userRef.set({
                name: username,
                phone: phone,
                online: true,
                lastSeen: Date.now()
            }).then(() => {
                currentUser = username;
                currentPhone = phone;
                userName.textContent = username;
                
                // Переходим на главный экран
                registerScreen.classList.remove('active');
                mainScreen.classList.add('active');
                
                // Инициализируем Agora
                initAgora();
                
                // Начинаем слушать входящие звонки
                setupIncomingCallListener();
                
                loader.classList.remove('active');
                showNotification(`Добро пожаловать, ${username}!`);
                
            }).catch(error => {
                loader.classList.remove('active');
                showNotification('Ошибка регистрации: ' + error.message);
                console.error('Registration error:', error);
            });
        }

        // Настройка слушателя входящих звонков
        function setupIncomingCallListener() {
            incomingCallListener = database.ref('calls/' + currentPhone);
            
            incomingCallListener.on('value', (snapshot) => {
                const callData = snapshot.val();
                
                if (callData && callData.status === 'ringing') {
                    // Показываем экран входящего звонка
                    callerName.textContent = callData.callerName;
                    callerPhone.textContent = callData.callerPhone;
                    callerAvatar.textContent = callData.callerName.charAt(0);
                    incomingCall.classList.add('active');
                    
                    // Сохраняем ID звонка для принятия
                    currentCallListener = callData.callId;
                    
                    // Автоматически отклоняем звонок через 30 секунд
                    setTimeout(() => {
                        if (incomingCall.classList.contains('active')) {
                            rejectIncomingCall();
                        }
                    }, 30000);
                }
            });
        }

        // Принять входящий звонок
        function acceptIncomingCall() {
            const callRef = database.ref('calls/' + currentPhone);
            
            callRef.update({
                status: 'accepted'
            }).then(() => {
                incomingCall.classList.remove('active');
                
                // Присоединяемся к комнате (номер звонящего = ID комнаты)
                joinRoom(callerPhone.textContent);
            });
        }

        // Отклонить входящий звонок
        function rejectIncomingCall() {
            const callRef = database.ref('calls/' + currentPhone);
            
            callRef.update({
                status: 'rejected'
            }).then(() => {
                incomingCall.classList.remove('active');
                showNotification('Звонок отклонен');
            });
        }

        // Совершить исходящий звонок
        function makeCall() {
            const targetPhone = phoneNumberDisplay.textContent.replace(/\D/g, '');
            
            if (!targetPhone || targetPhone === '+71234567894') {
                showNotification('Введите номер телефона');
                return;
            }
            
            if (targetPhone === currentPhone.replace(/\D/g, '')) {
                showNotification('Нельзя позвонить самому себе');
                return;
            }
            
            loader.classList.add('active');
            loaderText.textContent = 'Установка соединения...';
            
            // Проверяем, существует ли пользователь
            const targetUserRef = database.ref('users/' + targetPhone);
            
            targetUserRef.once('value').then((snapshot) => {
                const targetUser = snapshot.val();
                
                if (!targetUser) {
                    loader.classList.remove('active');
                    showNotification('Пользователь не найден');
                    return;
                }
                
                // Создаем запись о звонке
                const callRef = database.ref('calls/' + targetPhone);
                const callId = 'call_' + Date.now();
                
                callRef.set({
                    callerName: currentUser,
                    callerPhone: currentPhone,
                    status: 'ringing',
                    callId: callId,
                    createdAt: Date.now()
                }).then(() => {
                    loader.classList.remove('active');
                    showNotification(`Звонок пользователю ${targetUser.name}...`);
                    
                    // Слушаем ответ на звонок
                    const answerListener = callRef.on('value', (snapshot) => {
                        const callData = snapshot.val();
                        
                        if (callData && callData.status !== 'ringing') {
                            // Убираем слушатель
                            callRef.off('value', answerListener);
                            
                            if (callData.status === 'accepted') {
                                // Присоединяемся к комнате (номер целевого пользователя = ID комнаты)
                                joinRoom(targetPhone);
                            } else {
                                showNotification('Звонок отклонен');
                                callRef.remove();
                            }
                        }
                    });
                    
                    // Автоматически отменяем звонок через 30 секунд
                    setTimeout(() => {
                        callRef.off('value', answerListener);
                        callRef.remove();
                        showNotification('Звонок не отвечает');
                    }, 30000);
                    
                }).catch(error => {
                    loader.classList.remove('active');
                    showNotification('Ошибка звонка: ' + error.message);
                    console.error('Call error:', error);
                });
                
            }).catch(error => {
                loader.classList.remove('active');
                showNotification('Ошибка поиска пользователя: ' + error.message);
                console.error('User search error:', error);
            });
        }

        // Присоединиться к комнате
        async function joinRoom(roomId) {
            if (!client) {
                showNotification('Agora не инициализирован');
                return;
            }

            try {
                loader.classList.add('active');
                loaderText.textContent = 'Подключение к комнате...';
                
                // Присоединяемся к каналу (номер телефона = ID комнаты)
                await client.join(AGORA_APP_ID, roomId, null, currentUser);
                
                // Создаем и публикуем локальные треки
                const audioTrack = await AgoraRTC.createMicrophoneAudioTrack().catch(e => {
                    console.warn('Microphone error:', e);
                    showNotification('Микрофон недоступен');
                    return null;
                });
                
                const videoTrack = await AgoraRTC.createCameraVideoTrack().catch(e => {
                    console.warn('Camera error:', e);
                    showNotification('Камера недоступна');
                    return null;
                });

                localTracks = [audioTrack, videoTrack].filter(track => track !== null);
                
                if (localTracks.length > 0) {
                    await client.publish(localTracks);
                }
                
                // Показываем локальное видео
                if (videoTrack) {
                    localVideo.srcObject = new MediaStream([videoTrack.getMediaStreamTrack()]);
                    videoTrack.play(localVideo);
                }
                
                // Обновляем интерфейс
                roomInfo.textContent = `Звонок: ${roomId}`;
                
                mainScreen.classList.remove('active');
                callScreen.classList.add('active');
                
                loader.classList.remove('active');
                showNotification(`Вы в комнате ${roomId}`);
                
            } catch (error) {
                loader.classList.remove('active');
                showNotification('Ошибка подключения: ' + error.message);
                console.error('Join error:', error);
            }
        }

        // Выйти из комнаты
        async function leaveRoom() {
            try {
                // Отключаем локальные треки
                localTracks.forEach(track => {
                    if (track && track.close) {
                        track.close();
                    }
                });
                localTracks = [];
                
                // Выходим из канала
                if (client) {
                    await client.leave();
                }
                
                // Очищаем видео
                localVideo.srcObject = null;
                remoteVideo.srcObject = null;
                
                // Возвращаем на главный экран
                callScreen.classList.remove('active');
                mainScreen.classList.add('active');
                waitingText.style.display = 'block';
                
                showNotification('Вы вышли из звонка');
                
            } catch (error) {
                console.error('Leave error:', error);
            }
        }

        // Управление медиа
        micBtn.addEventListener('click', () => {
            const audioTrack = localTracks.find(track => track && track.trackMediaType === 'audio');
            if (audioTrack) {
                audioTrack.setEnabled(!audioTrack.enabled);
                micBtn.style.background = audioTrack.enabled ? 'var(--gradient)' : 'var(--accent)';
                showNotification(audioTrack.enabled ? 'Микрофон включен' : 'Микрофон выключен');
            }
        });

        cameraBtn.addEventListener('click', () => {
            const videoTrack = localTracks.find(track => track && track.trackMediaType === 'video');
            if (videoTrack) {
                videoTrack.setEnabled(!videoTrack.enabled);
                cameraBtn.style.background = videoTrack.enabled ? 'var(--gradient)' : 'var(--accent)';
                localVideo.style.display = videoTrack.enabled ? 'block' : 'none';
                showNotification(videoTrack.enabled ? 'Камера включена' : 'Камера выключена');
            }
        });

        // Переключение между вкладками
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const indicator = document.querySelector('.tab-indicator');

        function switchTab(tab) {
            const tabId = tab.getAttribute('data-tab');
            
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            const tabIndex = Array.from(tabs).indexOf(tab);
            indicator.style.transform = `translateX(${tabIndex * 100}%)`;
        }

        tabs.forEach(tab => {
            tab.addEventListener('click', () => switchTab(tab));
        });

        // Функциональность клавиатуры
        document.querySelectorAll('.key').forEach(key => {
            key.addEventListener('click', function() {
                const number = this.getAttribute('data-number');
                if (number) {
                    if (phoneNumberDisplay.textContent === '+7 (123) 456-78-94') {
                        phoneNumberDisplay.textContent = number;
                    } else {
                        phoneNumberDisplay.textContent += number;
                    }
                    
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 150);
                }
            });
        });

        // Обработка кнопки удаления
        deleteBtn.addEventListener('click', function() {
            let currentNumber = phoneNumberDisplay.textContent;
            if (currentNumber.length > 1 && currentNumber !== '+7 (123) 456-78-94') {
                phoneNumberDisplay.textContent = currentNumber.slice(0, -1);
            } else {
                phoneNumberDisplay.textContent = '+7 (123) 456-78-94';
            }
            
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 150);
        });

        // Обработка кнопки вызова
        makeCallBtn.addEventListener('click', function() {
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 150);
            
            makeCall();
        });

        // Слушатели событий
        registerBtn.addEventListener('click', registerUser);
        endCallBtn.addEventListener('click', leaveRoom);
        acceptCallBtn.addEventListener('click', acceptIncomingCall);
        rejectCallBtn.addEventListener('click', rejectIncomingCall);

        // Автозаполнение для теста
        usernameInput.value = 'User' + Math.floor(Math.random() * 1000);
        phoneInput.value = '+7' + Math.floor(9000000000 + Math.random() * 1000000000);

        // Инициализация при загрузке
        window.addEventListener('load', () => {
            showNotification('Система загружена');
        });
    </script>
</body>
    </html>
