<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
            text-align: center;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        button {
            background: #ffcc00;
            color: #333;
            border: none;
            padding: 15px 25px;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            font-weight: bold;
        }
        .status {
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .code {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî Push –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h1>
        
        <button onclick="subscribeToPush()">üì≤ –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
        
        <div id="status" class="status info">
            –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        </div>
        
        <div id="subscriptionData" style="display: none;">
            <h3>‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞!</h3>
            <div class="code" id="subscriptionJson"></div>
            <button onclick="sendTestNotification()" style="background: #28a745; color: white;">üöÄ –¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
        </div>
        
        <div style="margin-top: 20px; text-align: left; font-size: 14px;">
            <p><strong>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong></p>
            <p>1. –ù–∞–∂–∏–º–∞–µ—à—å "–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"</p>
            <p>2. –†–∞–∑—Ä–µ—à–∞–µ—à—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ</p>
            <p>3. –ü–æ–ª—É—á–∞–µ—à—å –¥–∞–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏</p>
            <p>4. –ù–∞–∂–∏–º–∞–µ—à—å "–¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"</p>
        </div>
    </div>

    <script>
        // VAPID –∫–ª—é—á –∏–∑ Yandex Cloud (–∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π)
        const VAPID_PUBLIC_KEY = 'BL3fJ4pX8k2z9mKqWrTvYx7cD0gH5nL8sP1bN6jM9qV3tR7wZ0yA4uF2iC5oE8h';
        
        let currentSubscription = null;

        async function subscribeToPush() {
            const statusDiv = document.getElementById('status');
            const subscriptionData = document.getElementById('subscriptionData');
            const subscriptionJson = document.getElementById('subscriptionJson');
            
            try {
                statusDiv.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—Ä–∞—É–∑–µ—Ä...';
                statusDiv.className = 'status info';

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É
                if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                    throw new Error('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
                }

                // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º Service Worker
                statusDiv.textContent = '‚è≥ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º...';
                const registration = await navigator.serviceWorker.register('/sw.js');
                await navigator.serviceWorker.ready;

                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
                statusDiv.textContent = '‚è≥ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ...';
                const permission = await Notification.requestPermission();
                
                if (permission !== 'granted') {
                    throw new Error('–¢—ã –Ω–µ —Ä–∞–∑—Ä–µ—à–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è üòî');
                }

                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ push
                statusDiv.textContent = '‚è≥ –°–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É...';
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });

                currentSubscription = subscription;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏
                const subData = subscription.toJSON();
                subscriptionJson.textContent = JSON.stringify(subData, null, 2);
                subscriptionData.style.display = 'block';
                
                statusDiv.textContent = '‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å';
                statusDiv.className = 'status success';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                new Notification('üéâ –£—Ä–∞!', {
                    body: 'Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç!',
                    icon: 'https://yastatic.net/s3/cloud/yc-web/1.0.0/yc-favicon.png'
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                statusDiv.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + error.message;
                statusDiv.className = 'status error';
            }
        }

        function sendTestNotification() {
            if (!currentSubscription) return;
            
            new Notification('üì± –¢–µ—Å—Ç —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞', {
                body: '–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ! –†–∞–±–æ—Ç–∞–µ—Ç! üöÄ',
                icon: 'https://yastatic.net/s3/cloud/yc-web/1.0.0/yc-favicon.png'
            });
        }

        // –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –∫–ª—é—á–∞
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥–ø–∏—Å–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', async () => {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.ready;
                    const subscription = await registration.pushManager.getSubscription();
                    
                    if (subscription) {
                        currentSubscription = subscription;
                        document.getElementById('subscriptionJson').textContent = JSON.stringify(subscription.toJSON(), null, 2);
                        document.getElementById('subscriptionData').style.display = 'block';
                        document.getElementById('status').textContent = '‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É–∂–µ –≤–∫–ª—é—á–µ–Ω—ã!';
                        document.getElementById('status').className = 'status success';
                    }
                } catch (error) {
                    console.log('–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }
            }
        });
    </script>
</body>
</html>
