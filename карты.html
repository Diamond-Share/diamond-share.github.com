<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MegaCar Navigator</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=27215835-f54e-4e9f-a747-54c3e38a4042&lang=ru_RU"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: relative;
            background: #121212;
            color: white;
        }

        #map {
            width: 100%;
            height: 100%;
            transition: all 0.5s ease;
        }

        .control-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #2a2a2a;
            color: white;
            border: none;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
        }

        .control-btn:hover {
            background: #3a3a3a;
            transform: scale(1.05);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn.active {
            background: #4CAF50;
        }

        .control-btn.warning {
            background: #f39c12;
        }

        .control-btn.danger {
            background: #e74c3c;
        }

        .control-btn.primary {
            background: #3498db;
        }

        #go-btn {
            width: 80px;
            height: 80px;
            font-size: 18px;
            background: linear-gradient(135deg, #4CAF50, #2ECC71);
            position: relative;
            overflow: hidden;
        }

        #go-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% {
                left: -50%;
                top: -50%;
            }
            100% {
                left: 150%;
                top: 150%;
            }
        }

        .route-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: none;
        }

        .route-panel.active {
            display: block;
        }

        .input-group {
            margin-bottom: 10px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #ccc;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }

        .route-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .route-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: #3498db;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .route-btn:hover {
            background: #2980b9;
        }

        .route-btn.cancel {
            background: #e74c3c;
        }

        .route-btn.cancel:hover {
            background: #c0392b;
        }

        .route-type {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .route-type-btn {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .route-type-btn.active {
            background: #3498db;
            font-weight: bold;
        }

        .status-bar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 90%;
        }

        .status-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-icon.connected {
            background: #2ecc71;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }

        .speed-display {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 50%;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 80px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .speed-display .unit {
            font-size: 12px;
            opacity: 0.7;
            margin-top: -5px;
        }

        .settings-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 400px;
            display: none;
        }

        .settings-panel.active {
            display: block;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .settings-title {
            font-size: 20px;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .settings-group {
            margin-bottom: 15px;
        }

        .settings-group-title {
            font-size: 16px;
            margin-bottom: 10px;
            color: #3498db;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item label {
            font-size: 14px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #3498db;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .volume-control {
            width: 100px;
        }

        /* Адаптивные стили */
        @media (max-width: 600px) {
            .control-panel {
                bottom: 10px;
                padding: 10px;
            }

            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            #go-btn {
                width: 70px;
                height: 70px;
            }

            .route-panel {
                top: 10px;
                left: 10px;
                right: 10px;
                padding: 10px;
            }

            .speed-display {
                width: 60px;
                height: 60px;
                font-size: 20px;
                padding: 10px;
            }
        }

        /* Анимации */
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .bounce {
            animation: bounce 1s infinite;
        }

        @keyframes shake {
            0%, 100% {
                transform: translateX(0);
            }
            10%, 30%, 50%, 70%, 90% {
                transform: translateX(-5px);
            }
            20%, 40%, 60%, 80% {
                transform: translateX(5px);
            }
        }

        .shake {
            animation: shake 0.5s;
        }

        /* Стили для маркера машины */
        .car-marker {
            width: 40px;
            height: 40px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="%234CAF50" d="M135.2 117.4L109.1 192H402.9l-26.1-74.6c-3.5-10-12.5-16.6-22.8-16.6H158c-10.3 0-19.3 6.6-22.8 16.6zM39.6 196.8L74.8 96.3C88.3 57.8 124.6 32 165.4 32H346.6c40.8 0 77.1 25.8 90.6 64.3l35.2 100.5c23.2 9.6 39.6 32.5 39.6 59.2V400v48c0 17.7-14.3 32-32 32H448c-17.7 0-32-14.3-32-32V400H96v48c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32V400 256c0-26.7 16.4-49.6 39.6-59.2zM128 288a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zm288 32a32 32 0 1 0 0-64 32 32 0 1 0 0 64z"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            transform: rotate(0deg);
            transition: transform 0.3s ease;
        }

        /* Стили для POI */
        .poi-marker {
            width: 30px;
            height: 30px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .gas-station {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="%23f39c12" d="M0 64C0 28.7 28.7 0 64 0H192c35.3 0 64 28.7 64 64V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V64zM256 192H384c17.7 0 32-14.3 32-32V64c0-17.7-14.3-32-32-32H256V192zM96 64c-17.7 0-32 14.3-32 32v32c0 17.7 14.3 32 32 32h32c17.7 0 32-14.3 32-32V96c0-17.7-14.3-32-32-32H96zm32 160v96c0 17.7-14.3 32-32 32s-32-14.3-32-32V224c0-17.7 14.3-32 32-32s32 14.3 32 32zm160-32c17.7 0 32 14.3 32 32v96c0 17.7-14.3 32-32 32s-32-14.3-32-32V224c0-17.7 14.3-32 32-32zM480 96V160c0 17.7-14.3 32-32 32s-32-14.3-32-32V96c0-17.7 14.3-32 32-32s32 14.3 32 32zM320 224v96c0 17.7-14.3 32-32 32s-32-14.3-32-32V224c0-17.7 14.3-32 32-32s32 14.3 32 32zm128-32c17.7 0 32 14.3 32 32v96c0 17.7-14.3 32-32 32s-32-14.3-32-32V224c0-17.7 14.3-32 32-32z"/></svg>');
        }

        .restaurant {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="%23e74c3c" d="M64 32C46.3 32 32 46.3 32 64v96c0 17.7 14.3 32 32 32h37.5c13.4 0 24.6 10.1 25.9 23.5C138.8 298.8 160.1 320 187.5 320h26.3c18.6 0 36.2-7.5 48.9-20.7C287.1 280.2 305.8 272 325.1 272h85.7c42.3 0 76.6-34.3 76.6-76.6c0-21.1-8.5-40.8-23.9-55.3l-85.7-85.7C371.8 42.4 357.6 32 342.3 32H64zM96 96h64v64H96V96zM0 432c0-26.5 21.5-48 48-48H464c26.5 0 48 21.5 48 48s-21.5 48-48 48H48c-26.5 0-48-21.5-48-48z"/></svg>');
        }

        .hotel {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="%233498db" d="M256 32c-17.7 0-32 14.3-32 32V288c0 17.7 14.3 32 32 32h32c17.7 0 32-14.3 32-32V64c0-17.7-14.3-32-32-32H256zm0 160c-17.7 0-32 14.3-32 32v64c0 17.7 14.3 32 32 32h32c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32H256zM32 128c-17.7 0-32 14.3-32 32V352c0 53 43 96 96 96H480c53 0 96-43 96-96V160c0-17.7-14.3-32-32-32s-32 14.3-32 32V352c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V160c0-17.7-14.3-32-32-32zm384 32v64c0 17.7 14.3 32 32 32h32c17.7 0 32-14.3 32-32V160c0-17.7-14.3-32-32-32H448c-17.7 0-32 14.3-32 32z"/></svg>');
        }

        /* Стили для маршрута */
        .route-info {
            position: absolute;
            bottom: 120px;
            left: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 300px;
            display: none;
        }

        .route-info.active {
            display: block;
        }

        .route-info-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2ecc71;
        }

        .route-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .route-info-item .label {
            color: #ccc;
        }

        .route-info-item .value {
            font-weight: bold;
        }

        /* Стили для следующего поворота */
        .next-turn {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 80px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.1);
            display: none;
        }

        .next-turn.active {
            display: flex;
        }

        .next-turn .distance {
            font-size: 12px;
            margin-top: 5px;
            color: #3498db;
        }

        /* Анимация поворота */
        @keyframes turnHighlight {
            0% {
                transform: translateY(-50%) scale(1);
                box-shadow: 0 0 0 rgba(52, 152, 219, 0);
            }
            50% {
                transform: translateY(-50%) scale(1.1);
                box-shadow: 0 0 20px rgba(52, 152, 219, 0.5);
            }
            100% {
                transform: translateY(-50%) scale(1);
                box-shadow: 0 0 0 rgba(52, 152, 219, 0);
            }
        }

        .turn-highlight {
            animation: turnHighlight 1s;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Статус бар -->
    <div class="status-bar">
        <div class="status-icon"></div>
        <span>Подключение к GPS...</span>
    </div>
    
    <!-- Отображение скорости -->
    <div class="speed-display">
        <span id="speed-value">0</span>
        <span class="unit">км/ч</span>
    </div>
    
    <!-- Индикатор следующего поворота -->
    <div class="next-turn" id="next-turn">
        <div class="turn-icon">→</div>
        <div class="distance">100 м</div>
    </div>
    
    <!-- Информация о маршруте -->
    <div class="route-info" id="route-info">
        <div class="route-info-title">Маршрут активен</div>
        <div class="route-info-item">
            <span class="label">Расстояние:</span>
            <span class="value" id="route-distance">0 км</span>
        </div>
        <div class="route-info-item">
            <span class="label">Время:</span>
            <span class="value" id="route-time">0 мин</span>
        </div>
        <div class="route-info-item">
            <span class="label">До цели:</span>
            <span class="value" id="route-remaining">0 км</span>
        </div>
    </div>
    
    <!-- Панель маршрута -->
    <div class="route-panel" id="route-panel">
        <div class="input-group">
            <label for="from-input">Откуда</label>
            <input type="text" id="from-input" placeholder="Текущее местоположение">
        </div>
        <div class="input-group">
            <label for="to-input">Куда</label>
            <input type="text" id="to-input" placeholder="Введите адрес">
        </div>
        <div class="route-type">
            <button class="route-type-btn active" data-type="fastest">Быстрый</button>
            <button class="route-type-btn" data-type="shortest">Короткий</button>
            <button class="route-type-btn" data-type="economical">Экономный</button>
        </div>
        <div class="route-actions">
            <button class="route-btn cancel" id="cancel-route-btn">Отмена</button>
            <button class="route-btn" id="build-route-btn">Построить маршрут</button>
        </div>
    </div>
    
    <!-- Панель настроек -->
    <div class="settings-panel" id="settings-panel">
        <div class="settings-header">
            <div class="settings-title">Настройки</div>
            <button class="close-btn" id="close-settings-btn">×</button>
        </div>
        <div class="settings-group">
            <div class="settings-group-title">Навигация</div>
            <div class="settings-item">
                <label for="avoid-traffic">Избегать пробок</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="avoid-traffic" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="settings-item">
                <label for="avoid-tolls">Избегать платных дорог</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="avoid-tolls">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
        <div class="settings-group">
            <div class="settings-group-title">Звуки</div>
            <div class="settings-item">
                <label for="sound-enabled">Включить звуки</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="sound-enabled" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="settings-item">
                <label for="volume-control">Громкость</label>
                <input type="range" id="volume-control" min="0" max="1" step="0.1" value="0.7" class="volume-control">
            </div>
        </div>
        <div class="settings-group">
            <div class="settings-group-title">Вид карты</div>
            <div class="settings-item">
                <label for="map-type">3D режим</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="map-type">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>
    
    <!-- Панель управления -->
    <div class="control-panel">
        <button class="control-btn" id="menu-btn" title="Меню">☰</button>
        <button class="control-btn" id="home-btn" title="Домой">⌂</button>
        <button class="control-btn" id="route-btn" title="Маршрут">⇄</button>
        <button class="control-btn primary" id="go-btn" title="Поехали!">GO</button>
        <button class="control-btn" id="zoom-in-btn" title="Приблизить">+</button>
        <button class="control-btn" id="zoom-out-btn" title="Отдалить">-</button>
        <button class="control-btn" id="settings-btn" title="Настройки">⚙</button>
    </div>
    
    <!-- Аудио элементы -->
    <audio id="start-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3"></audio>
    <audio id="arrive-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3"></audio>
    <audio id="turn-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-retro-arcade-game-notification-276.mp3"></audio>
    <audio id="warning-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3"></audio>
    
    <script>
        // Основной объект приложения
        const app = {
            map: null,
            carMarker: null,
            route: null,
            currentPosition: null,
            gpsWatchId: null,
            routePanelVisible: false,
            settingsPanelVisible: false,
            isNavigationActive: false,
            is3DMode: false,
            routeType: 'fastest',
            soundEnabled: true,
            volume: 0.7,
            avoidTraffic: true,
            avoidTolls: false,
            poiMarkers: [],
            lastTurnNotification: null,
            
            // Инициализация приложения
            init: function() {
                this.initMap();
                this.initControls();
                this.initAudio();
                this.checkGPS();
                this.updateStatus('Инициализация завершена', true);
                
                // Загрузка POI (точек интереса)
                setTimeout(() => {
                    this.loadPOIs();
                }, 2000);
            },
            
            // Инициализация карты
            initMap: function() {
                ymaps.ready(() => {
                    this.map = new ymaps.Map('map', {
                        center: [55.751574, 37.573856], // Москва по умолчанию
                        zoom: 12,
                        controls: []
                    });
                    
                    // Создаем маркер машины
                    this.carMarker = new ymaps.Placemark([0, 0], {}, {
                        iconLayout: 'default#image',
                        iconImageHref: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="%234CAF50" d="M135.2 117.4L109.1 192H402.9l-26.1-74.6c-3.5-10-12.5-16.6-22.8-16.6H158c-10.3 0-19.3 6.6-22.8 16.6zM39.6 196.8L74.8 96.3C88.3 57.8 124.6 32 165.4 32H346.6c40.8 0 77.1 25.8 90.6 64.3l35.2 100.5c23.2 9.6 39.6 32.5 39.6 59.2V400v48c0 17.7-14.3 32-32 32H448c-17.7 0-32-14.3-32-32V400H96v48c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32V400 256c0-26.7 16.4-49.6 39.6-59.2zM128 288a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zm288 32a32 32 0 1 0 0-64 32 32 0 1 0 0 64z"/></svg>',
                        iconImageSize: [40, 40],
                        iconImageOffset: [-20, -20],
                        zIndex: 1000
                    });
                    
                    this.map.geoObjects.add(this.carMarker);
                    this.carMarker.options.set('visible', false);
                    
                    // Добавляем элементы управления
                    this.map.controls.add('zoomControl', {
                        size: 'small',
                        position: {
                            right: 10,
                            top: 100
                        }
                    });
                    
                    this.map.controls.add('typeSelector', {
                        position: {
                            right: 10,
                            top: 150
                        }
                    });
                    
                    this.map.controls.add('fullscreenControl', {
                        position: {
                            right: 10,
                            top: 200
                        }
                    });
                    
                    // Включаем отображение пробок
                    this.map.controls.add('trafficControl', {
                        position: {
                            right: 10,
                            top: 250
                        }
                    });
                    
                    this.updateStatus('Карта загружена', true);
                });
            },
            
            // Инициализация элементов управления
            initControls: function() {
                // Кнопка "Поехали"
                document.getElementById('go-btn').addEventListener('click', () => {
                    this.startNavigation();
                    this.playSound('start');
                });
                
                // Кнопка маршрута
                document.getElementById('route-btn').addEventListener('click', () => {
                    this.toggleRoutePanel();
                });
                
                // Кнопка отмены маршрута
                document.getElementById('cancel-route-btn').addEventListener('click', () => {
                    this.toggleRoutePanel();
                });
                
                // Кнопка построения маршрута
                document.getElementById('build-route-btn').addEventListener('click', () => {
                    this.buildRoute();
                });
                
                // Кнопки типа маршрута
                document.querySelectorAll('.route-type-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.route-type-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.routeType = btn.dataset.type;
                    });
                });
                
                // Кнопка настроек
                document.getElementById('settings-btn').addEventListener('click', () => {
                    this.toggleSettingsPanel();
                });
                
                // Кнопка закрытия настроек
                document.getElementById('close-settings-btn').addEventListener('click', () => {
                    this.toggleSettingsPanel();
                });
                
                // Кнопка домой
                document.getElementById('home-btn').addEventListener('click', () => {
                    if (this.currentPosition) {
                        this.map.setCenter([this.currentPosition.coords.latitude, this.currentPosition.coords.longitude], 15);
                        this.playSound('turn');
                    }
                });
                
                // Кнопки масштабирования
                document.getElementById('zoom-in-btn').addEventListener('click', () => {
                    this.map.setZoom(this.map.getZoom() + 1);
                });
                
                document.getElementById('zoom-out-btn').addEventListener('click', () => {
                    this.map.setZoom(this.map.getZoom() - 1);
                });
                
                // Переключатель 3D режима
                document.getElementById('map-type').addEventListener('change', (e) => {
                    this.is3DMode = e.target.checked;
                    if (this.is3DMode) {
                        this.map.setType('yandex#hybrid');
                    } else {
                        this.map.setType('yandex#map');
                    }
                });
                
                // Переключатель звуков
                document.getElementById('sound-enabled').addEventListener('change', (e) => {
                    this.soundEnabled = e.target.checked;
                });
                
                // Регулятор громкости
                document.getElementById('volume-control').addEventListener('input', (e) => {
                    this.volume = parseFloat(e.target.value);
                });
                
                // Переключатель пробок
                document.getElementById('avoid-traffic').addEventListener('change', (e) => {
                    this.avoidTraffic = e.target.checked;
                    if (this.route) {
                        this.updateRoute();
                    }
                });
                
                // Переключатель платных дорог
                document.getElementById('avoid-tolls').addEventListener('change', (e) => {
                    this.avoidTolls = e.target.checked;
                    if (this.route) {
                        this.updateRoute();
                    }
                });
            },
            
            // Инициализация аудио
            initAudio: function() {
                this.audioElements = {
                    start: document.getElementById('start-sound'),
                    arrive: document.getElementById('arrive-sound'),
                    turn: document.getElementById('turn-sound'),
                    warning: document.getElementById('warning-sound')
                };
            },
            
            // Проверка доступности GPS
            checkGPS: function() {
                if ('geolocation' in navigator) {
                    this.updateStatus('GPS доступен', true);
                    // Запускаем отслеживание положения
                    this.startWatchingPosition();
                } else {
                    this.updateStatus('GPS недоступен', false);
                }
            },
            
            // Начать отслеживание положения
            startWatchingPosition: function() {
                this.gpsWatchId = navigator.geolocation.watchPosition(
                    (position) => {
                        this.handlePositionUpdate(position);
                    },
                    (error) => {
                        this.handlePositionError(error);
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 30000,
                        timeout: 27000
                    }
                );
            },
            
            // Обработка обновления позиции
            handlePositionUpdate: function(position) {
                this.currentPosition = position;
                const coords = [position.coords.latitude, position.coords.longitude];
                
                // Обновляем маркер машины
                this.carMarker.geometry.setCoordinates(coords);
                this.carMarker.options.set('visible', true);
                
                // Поворачиваем маркер машины в соответствии с направлением движения
                if (position.coords.heading !== null && !isNaN(position.coords.heading)) {
                    this.carMarker.options.set('iconImageOffset', [-20, -20]);
                    this.carMarker.options.set('iconImageSize', [40, 40]);
                    this.carMarker.properties.set('iconContent', '');
                    this.carMarker.options.set('iconLayout', 'default#imageWithContent');
                    this.carMarker.options.set('iconImageHref', 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="%234CAF50" d="M135.2 117.4L109.1 192H402.9l-26.1-74.6c-3.5-10-12.5-16.6-22.8-16.6H158c-10.3 0-19.3 6.6-22.8 16.6zM39.6 196.8L74.8 96.3C88.3 57.8 124.6 32 165.4 32H346.6c40.8 0 77.1 25.8 90.6 64.3l35.2 100.5c23.2 9.6 39.6 32.5 39.6 59.2V400v48c0 17.7-14.3 32-32 32H448c-17.7 0-32-14.3-32-32V400H96v48c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32V400 256c0-26.7 16.4-49.6 39.6-59.2zM128 288a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zm288 32a32 32 0 1 0 0-64 32 32 0 1 0 0 64z"/></svg>');
                    this.carMarker.options.set('iconImageSize', [40, 40]);
                    this.carMarker.options.set('rotation', position.coords.heading);
                }
                
                // Обновляем скорость
                if (position.coords.speed !== null && !isNaN(position.coords.speed)) {
                    const speedKmh = Math.round(position.coords.speed * 3.6);
                    document.getElementById('speed-value').textContent = speedKmh;
                    
                    // Подсвечиваем скорость при превышении 60 км/ч
                    const speedDisplay = document.querySelector('.speed-display');
                    if (speedKmh > 60) {
                        speedDisplay.style.color = '#e74c3c';
                        speedDisplay.style.borderColor = '#e74c3c';
                        this.playSound('warning');
                    } else {
                        speedDisplay.style.color = 'white';
                        speedDisplay.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                    }
                }
                
                // Если навигация активна, обновляем маршрут
                if (this.isNavigationActive && this.route) {
                    this.updateRouteInfo();
                    this.checkNextTurn(position);
                }
                
                // Центрируем карту на текущей позиции при первом обновлении
                if (!this.mapCenterSet) {
                    this.map.setCenter(coords, 15);
                    this.mapCenterSet = true;
                    this.updateStatus('Позиция определена', true);
                }
            },
            
            // Обработка ошибок GPS
            handlePositionError: function(error) {
                let message;
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message = "Доступ к GPS запрещен пользователем";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = "Информация о местоположении недоступна";
                        break;
                    case error.TIMEOUT:
                        message = "Время ожидания определения местоположения истекло";
                        break;
                    case error.UNKNOWN_ERROR:
                        message = "Произошла неизвестная ошибка";
                        break;
                }
                this.updateStatus(message, false);
            },
            
            // Обновление статус бара
            updateStatus: function(message, isSuccess) {
                const statusBar = document.querySelector('.status-bar');
                const statusIcon = document.querySelector('.status-icon');
                
                statusBar.querySelector('span').textContent = message;
                
                if (isSuccess) {
                    statusIcon.classList.add('connected');
                    statusBar.style.color = '#2ecc71';
                } else {
                    statusIcon.classList.remove('connected');
                    statusBar.style.color = '#e74c3c';
                }
                
                // Автоматическое скрытие статус бара через 3 секунды
                clearTimeout(this.statusTimeout);
                this.statusTimeout = setTimeout(() => {
                    statusBar.style.opacity = '0';
                    setTimeout(() => {
                        statusBar.style.display = 'none';
                    }, 500);
                }, 3000);
                
                statusBar.style.display = 'flex';
                statusBar.style.opacity = '1';
            },
            
            // Начать навигацию
            startNavigation: function() {
                if (!this.currentPosition) {
                    this.updateStatus('Ожидание определения местоположения', false);
                    return;
                }
                
                this.isNavigationActive = true;
                document.getElementById('go-btn').classList.add('active', 'bounce');
                this.map.setCenter([this.currentPosition.coords.latitude, this.currentPosition.coords.longitude], 15);
                
                // Показываем информацию о маршруте, если он есть
                if (this.route) {
                    document.getElementById('route-info').classList.add('active');
                }
                
                this.updateStatus('Навигация начата', true);
            },
            
            // Остановить навигацию
            stopNavigation: function() {
                this.isNavigationActive = false;
                document.getElementById('go-btn').classList.remove('active', 'bounce');
                document.getElementById('route-info').classList.remove('active');
                document.getElementById('next-turn').classList.remove('active');
                this.updateStatus('Навигация остановлена', false);
            },
            
            // Переключение панели маршрута
            toggleRoutePanel: function() {
                this.routePanelVisible = !this.routePanelVisible;
                const panel = document.getElementById('route-panel');
                
                if (this.routePanelVisible) {
                    panel.classList.add('active');
                    // Устанавливаем текущее местоположение в поле "Откуда"
                    if (this.currentPosition) {
                        this.geocode([this.currentPosition.coords.latitude, this.currentPosition.coords.longitude])
                            .then(address => {
                                document.getElementById('from-input').value = address;
                            });
                    }
                } else {
                    panel.classList.remove('active');
                }
            },
            
            // Переключение панели настроек
            toggleSettingsPanel: function() {
                this.settingsPanelVisible = !this.settingsPanelVisible;
                const panel = document.getElementById('settings-panel');
                
                if (this.settingsPanelVisible) {
                    panel.classList.add('active');
                } else {
                    panel.classList.remove('active');
                }
            },
            
            // Построение маршрута
            buildRoute: function() {
                const fromInput = document.getElementById('from-input').value;
                const toInput = document.getElementById('to-input').value;
                
                if (!toInput) {
                    this.updateStatus('Введите пункт назначения', false);
                    return;
                }
                
                this.updateStatus('Построение маршрута...', true);
                
                // Если поле "Откуда" пустое, используем текущее местоположение
                if (!fromInput && this.currentPosition) {
                    const fromCoords = [this.currentPosition.coords.latitude, this.currentPosition.coords.longitude];
                    this.createRoute(fromCoords, toInput);
                } else if (fromInput) {
                    // Геокодируем адрес отправления
                    ymaps.geocode(fromInput, { results: 1 })
                        .then(res => {
                            const fromCoords = res.geoObjects.get(0).geometry.getCoordinates();
                            this.createRoute(fromCoords, toInput);
                        })
                        .catch(() => {
                            this.updateStatus('Не удалось определить адрес отправления', false);
                        });
                } else {
                    this.updateStatus('Не удалось определить начальную точку', false);
                }
            },
            
            // Создание маршрута между точками
            createRoute: function(fromCoords, toAddress) {
                // Удаляем предыдущий маршрут, если есть
                if (this.route) {
                    this.map.geoObjects.remove(this.route);
                }
                
                // Геокодируем адрес назначения
                ymaps.geocode(toAddress, { results: 1 })
                    .then(res => {
                        const toCoords = res.geoObjects.get(0).geometry.getCoordinates();
                        
                        // Определяем параметры маршрута в зависимости от выбранного типа
                        let routingMode;
                        switch(this.routeType) {
                            case 'fastest':
                                routingMode = 'auto';
                                break;
                            case 'shortest':
                                routingMode = 'masstransit';
                                break;
                            case 'economical':
                                routingMode = 'pedestrian';
                                break;
                            default:
                                routingMode = 'auto';
                        }
                        
                        // Параметры маршрута
                        const params = {
                            routingMode: routingMode,
                            avoidTraffic: this.avoidTraffic,
                            avoidTolls: this.avoidTolls
                        };
                        
                        // Создаем маршрут
                        ymaps.route([
                            { type: 'waypoint', point: fromCoords },
                            { type: 'waypoint', point: toCoords }
                        ], params)
                            .then(route => {
                                this.route = route;
                                this.map.geoObjects.add(route);
                                
                                // Устанавливаем границы карты так, чтобы был виден весь маршрут
                                this.map.setBounds(route.getWayPoints().getBounds(), {
                                    checkZoomRange: true
                                });
                                
                                // Обновляем информацию о маршруте
                                this.updateRouteInfo();
                                
                                // Скрываем панель маршрута
                                this.toggleRoutePanel();
                                
                                // Если навигация активна, показываем информацию о маршруте
                                if (this.isNavigationActive) {
                                    document.getElementById('route-info').classList.add('active');
                                }
                                
                                this.updateStatus('Маршрут построен', true);
                                this.playSound('start');
                            })
                            .catch(err => {
                                this.updateStatus('Ошибка построения маршрута', false);
                                console.error(err);
                            });
                    })
                    .catch(() => {
                        this.updateStatus('Не удалось определить адрес назначения', false);
                    });
            },
            
            // Обновление маршрута (при изменении параметров)
            updateRoute: function() {
                if (!this.route) return;
                
                const wayPoints = this.route.getWayPoints();
                const fromCoords = wayPoints.get(0).geometry.getCoordinates();
                const toCoords = wayPoints.get(1).geometry.getCoordinates();
                
                // Удаляем старый маршрут
                this.map.geoObjects.remove(this.route);
                
                // Создаем новый маршрут с обновленными параметрами
                this.createRoute(fromCoords, toCoords);
            },
            
            // Обновление информации о маршруте
            updateRouteInfo: function() {
                if (!this.route || !this.currentPosition) return;
                
                // Получаем информацию о маршруте
                const routeLength = this.route.getLength();
                const routeTime = this.route.getTime();
                
                // Вычисляем оставшееся расстояние
                const remainingPath = this.route.getPaths().getClosestTo(
                    [this.currentPosition.coords.latitude, this.currentPosition.coords.longitude]
                ).getSegments();
                
                let remainingDistance = 0;
                remainingPath.forEach(segment => {
                    remainingDistance += segment.getLength();
                });
                
                // Обновляем UI
                document.getElementById('route-distance').textContent = `${(routeLength / 1000).toFixed(1)} км`;
                document.getElementById('route-time').textContent = `${Math.round(routeTime / 60)} мин`;
                document.getElementById('route-remaining').textContent = `${(remainingDistance / 1000).toFixed(1)} км`;
                
                // Если осталось менее 100 метров, воспроизводим звук прибытия
                if (remainingDistance < 100 && this.lastTurnNotification !== 'arrive') {
                    this.playSound('arrive');
                    this.lastTurnNotification = 'arrive';
                    this.updateStatus('Прибытие на место назначения', true);
                }
            },
            
            // Проверка следующего поворота
            checkNextTurn: function(position) {
                if (!this.route || !position.coords.heading) return;
                
                const currentCoords = [position.coords.latitude, position.coords.longitude];
                const path = this.route.getPaths().getClosestTo(currentCoords).getSegments();
                
                // Находим следующий поворот (изменение направления)
                let nextTurn = null;
                let turnDistance = Infinity;
                
                for (let i = 0; i < path.length; i++) {
                    const segment = path[i];
                    const segmentCoords = segment.getCoordinates();
                    
                    // Проверяем только сегменты с достаточной длиной
                    if (segment.getLength() > 50) {
                        const start = segmentCoords[0];
                        const end = segmentCoords[segmentCoords.length - 1];
                        
                        // Вычисляем направление сегмента
                        const segmentBearing = this.calculateBearing(start, end);
                        
                        // Если направление сегмента отличается от текущего направления движения более чем на 30 градусов
                        if (Math.abs(this.normalizeAngle(segmentBearing - position.coords.heading)) > 30) {
                            // Вычисляем расстояние до начала сегмента
                            const dist = this.calculateDistance(currentCoords, start);
                            
                            if (dist < turnDistance && dist > 20) { // Игнорируем очень близкие повороты
                                nextTurn = segment;
                                turnDistance = dist;
                            }
                        }
                    }
                }
                
                // Обновляем UI следующего поворота
                if (nextTurn && turnDistance < 500) { // Показываем только если поворот ближе 500м
                    const turnIcon = document.querySelector('#next-turn .turn-icon');
                    const turnDistanceEl = document.querySelector('#next-turn .distance');
                    
                    // Определяем направление поворота
                    const segmentCoords = nextTurn.getCoordinates();
                    const start = segmentCoords[0];
                    const end = segmentCoords[segmentCoords.length - 1];
                    const segmentBearing = this.calculateBearing(start, end);
                    const turnAngle = this.normalizeAngle(segmentBearing - position.coords.heading);
                    
                    // Устанавливаем соответствующую иконку
                    if (turnAngle > 30 && turnAngle < 150) {
                        turnIcon.textContent = '→'; // Правый поворот
                    } else if (turnAngle < -30 && turnAngle > -150) {
                        turnIcon.textContent = '←'; // Левый поворот
                    } else if (Math.abs(turnAngle) > 150) {
                        turnIcon.textContent = '↩'; // Разворот
                    } else {
                        turnIcon.textContent = '↑'; // Прямо (не должно происходить из-за условия выше)
                    }
                    
                    // Обновляем расстояние
                    if (turnDistance > 1000) {
                        turnDistanceEl.textContent = `${(turnDistance / 1000).toFixed(1)} км`;
                    } else {
                        turnDistanceEl.textContent = `${Math.round(turnDistance)} м`;
                    }
                    
                    // Показываем панель поворота
                    const nextTurnEl = document.getElementById('next-turn');
                    nextTurnEl.classList.add('active');
                    
                    // Если поворот ближе 200м, подсвечиваем и воспроизводим звук
                    if (turnDistance < 200 && this.lastTurnNotification !== nextTurn) {
                        nextTurnEl.classList.add('turn-highlight');
                        setTimeout(() => {
                            nextTurnEl.classList.remove('turn-highlight');
                        }, 1000);
                        
                        this.playSound('turn');
                        this.lastTurnNotification = nextTurn;
                    }
                } else {
                    document.getElementById('next-turn').classList.remove('active');
                    this.lastTurnNotification = null;
                }
            },
            
            // Загрузка точек интереса (POI) вокруг текущего местоположения
            loadPOIs: function() {
                if (!this.currentPosition) return;
                
                const coords = [this.currentPosition.coords.latitude, this.currentPosition.coords.longitude];
                const searchRadius = 2000; // 2 км
                
                // Удаляем старые POI
                this.poiMarkers.forEach(marker => {
                    this.map.geoObjects.remove(marker);
                });
                this.poiMarkers = [];
                
                // Поиск АЗС
                ymaps.geoQuery(ymaps.geocode(`АЗС`, {
                    boundedBy: this.map.getBounds(),
                    results: 10
                })).then(res => {
                    res.each(obj => {
                        const marker = new ymaps.Placemark(obj.geometry.getCoordinates(), {
                            iconContent: '⛽',
                            hintContent: 'АЗС'
                        }, {
                            preset: 'islands#blueGasIcon',
                            iconColor: '#f39c12'
                        });
                        this.map.geoObjects.add(marker);
                        this.poiMarkers.push(marker);
                    });
                });
                
                // Поиск ресторанов
                ymaps.geoQuery(ymaps.geocode(`Ресторан`, {
                    boundedBy: this.map.getBounds(),
                    results: 10
                })).then(res => {
                    res.each(obj => {
                        const marker = new ymaps.Placemark(obj.geometry.getCoordinates(), {
                            iconContent: '🍴',
                            hintContent: 'Ресторан'
                        }, {
                            preset: 'islands#blueFoodIcon',
                            iconColor: '#e74c3c'
                        });
                        this.map.geoObjects.add(marker);
                        this.poiMarkers.push(marker);
                    });
                });
                
                // Поиск отелей
                ymaps.geoQuery(ymaps.geocode(`Отель`, {
                    boundedBy: this.map.getBounds(),
                    results: 10
                })).then(res => {
                    res.each(obj => {
                        const marker = new ymaps.Placemark(obj.geometry.getCoordinates(), {
                            iconContent: '🏨',
                            hintContent: 'Отель'
                        }, {
                            preset: 'islands#blueHomeIcon',
                            iconColor: '#3498db'
                        });
                        this.map.geoObjects.add(marker);
                        this.poiMarkers.push(marker);
                    });
                });
            },
            
            // Геокодирование координат в адрес
            geocode: function(coords) {
                return ymaps.geocode(coords).then(function(res) {
                    return res.geoObjects.get(0).properties.get('name');
                });
            },
            
            // Воспроизведение звука
            playSound: function(type) {
                if (!this.soundEnabled) return;
                
                const audio = this.audioElements[type];
                if (audio) {
                    audio.volume = this.volume;
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log('Audio play error:', e));
                }
            },
            
            // Вычисление расстояния между двумя точками в метрах
            calculateDistance: function(coord1, coord2) {
                const lat1 = coord1[0];
                const lon1 = coord1[1];
                const lat2 = coord2[0];
                const lon2 = coord2[1];
                
                const R = 6371e3; // радиус Земли в метрах
                const φ1 = lat1 * Math.PI / 180;
                const φ2 = lat2 * Math.PI / 180;
                const Δφ = (lat2 - lat1) * Math.PI / 180;
                const Δλ = (lon2 - lon1) * Math.PI / 180;
                
                const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                          Math.cos(φ1) * Math.cos(φ2) *
                          Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                
                return R * c;
            },
            
            // Вычисление направления между двумя точками в градусах
            calculateBearing: function(coord1, coord2) {
                const lat1 = coord1[0] * Math.PI / 180;
                const lon1 = coord1[1] * Math.PI / 180;
                const lat2 = coord2[0] * Math.PI / 180;
                const lon2 = coord2[1] * Math.PI / 180;
                
                const y = Math.sin(lon2 - lon1) * Math.cos(lat2);
                const x = Math.cos(lat1) * Math.sin(lat2) -
                          Math.sin(lat1) * Math.cos(lat2) * Math.cos(lon2 - lon1);
                const θ = Math.atan2(y, x);
                
                return this.normalizeAngle(θ * 180 / Math.PI);
            },
            
            // Нормализация угла к диапазону 0-360
            normalizeAngle: function(angle) {
                return (angle + 360) % 360;
            }
        };
        
        // Инициализация приложения после загрузки страницы
        window.addEventListener('load', () => {
            app.init();
        });
    </script>
</body>
</html>